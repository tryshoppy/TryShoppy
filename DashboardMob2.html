<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TRY SHOPPY - Mobile Dashboard v8</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#0d6efd;
  --bg:#f4f7fe;
  --white:#fff;
  --text:#1e293b;
  --border:#cbd5e1;
  --success:#22c55e;
  --danger:#dc2626;
}

body{
  font-family:'Cairo',sans-serif;
  background:var(--bg);
  margin:0;
  padding:10px;
  color:var(--text);
  font-size:16px;
}

.container{max-width:600px; margin:auto;}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:2px solid var(--primary);
  padding:10px 5px;
  margin-bottom:15px;
}

header .logo { font-weight: 900; font-size: 1.2rem; color: var(--primary); }

.filters{
  background:#fff;
  padding:15px;
  border-radius:15px;
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-bottom:15px;
  box-shadow:0 2px 10px rgba(0,0,0,.05);
}

.filters input, .filters select, .filters button{
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  font-family:'Cairo';
  width:100%;
  font-size:15px;
  box-sizing: border-box;
}

.btn-search{background:var(--primary); color:#fff; font-weight:bold; cursor:pointer; border:none;}
.btn-group{background:#1a1a1a; color:#fff; font-weight:bold; cursor:pointer; border:none;}

.cards-container{ display:flex; flex-direction:column; gap:15px; }

.order-card{
  background:#fff;
  border-radius:18px;
  padding:15px;
  box-shadow:0 3px 12px rgba(0,0,0,0.06);
  border-right:8px solid var(--primary);
  position: relative;
}

.order-card.grouped { border-right-color: #000; }

.card-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
  border-bottom: 1px dashed var(--border);
  padding-bottom: 8px;
}

.order-id { font-weight: 900; color: var(--primary); }

.field{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.field label{ font-weight:700; color:#64748b; font-size: 14px; }
.field span { font-weight: 600; color: var(--text); }

.field input, .field select{
  width:130px;
  padding:8px;
  border-radius:8px;
  border:1px solid var(--border);
  text-align:center;
  font-family:'Cairo';
  font-size:14px;
  font-weight: bold;
}

.net-box {
  background: #f0fdf4;
  padding: 10px;
  border-radius: 10px;
  margin: 10px 0;
  text-align: center;
  border: 1px solid #dcfce7;
}

.net-label { display: block; font-size: 12px; color: #166534; font-weight: bold; }
.net-value { font-size: 20px; font-weight: 900; color: var(--success); }

.actions{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
  margin-top:10px;
}

.btn-update{
  background:var(--success);
  color:#fff;
  border:none;
  padding:12px;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}

.link-btn{
  background: #eff6ff;
  color: var(--primary);
  padding: 10px;
  border-radius: 10px;
  text-align: center;
  text-decoration: none;
  font-weight: bold;
  font-size: 14px;
}

.spec-row {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-bottom: 10px;
}
.badge {
    background: #f1f5f9;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 12px;
    color: #475569;
    font-weight: 600;
}
</style>
</head>

<body style="display:none;">

<script>
const SESSION_TIME=2*60*60*1000;
const auth=localStorage.getItem("auth");
const loginTime=localStorage.getItem("loginTime");
const now=new Date().getTime();

if(auth==="true"&&loginTime&&(now-loginTime<SESSION_TIME)){
  document.body.style.display="block";
}else{
  const password=prompt("Enter Password:");
  if(password==="12345678"){
    localStorage.setItem("auth","true");
    localStorage.setItem("loginTime",now);
    document.body.style.display="block";
  }else{
    document.body.innerHTML="<h2 style='text-align:center;margin-top:50px;'>Access Denied âŒ</h2>";
  }
}
</script>

<div class="container">
<header>
  <div class="logo">TRY SHOPPY</div>
  <button onclick="logout()" style="background:#dc2626;color:white;border:none;padding:6px 12px;border-radius:8px; font-family: 'Cairo';">Ø®Ø±ÙˆØ¬</button>
</header>

<div class="filters">
  <div style="display: flex; gap: 5px;">
    <input type="date" id="dateFrom">
    <input type="date" id="dateTo">
  </div>
  <input id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† Ø£Ùˆ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±">
  <select id="searchStatus">
    <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
    <option>Pending Review</option>
    <option>Confirmed Via Try</option>
    <option>Processing</option>
    <option>Placed</option>
    <option>Shipped To You</option>
    <option>Delivered</option>
    <option>Canceled</option>
  </select>
  <button class="btn-search" onclick="applyFilters()">Ø¨Ø­Ø«</button>
  <button class="btn-group" onclick="toggleGrouping()">ğŸ‘¥ ØªØ¬Ù…ÙŠØ¹ / ÙÙƒ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
</div>

<div id="cardsContainer" class="cards-container"></div>
</div>

<script>
const scriptURL="https://script.google.com/macros/s/AKfycby-HrSH3DwpAPJAuhiAPlBJAngy-_qUZ7-O925hTA7FnbBVHkrjprfJavEA-WKyofIdlg/exec";
let ordersData=[];
let isGrouped=false;

async function loadData(){
  try {
    const res=await fetch(scriptURL, { redirect: 'follow' });
    ordersData=await res.json();
    applyFilters();
  } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„"); }
}

function renderCards(data){
  const container=document.getElementById("cardsContainer");
  container.innerHTML="";

  data.forEach(o=>{
    const orderId = o.order;
    const cleanOrderId = orderId.toString().split(' + ')[0];
    const qty = o.quantity || 1;
    const weight = o.weight || 0;
    const dims = o.dimensions || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

    const total = parseFloat(o.finalPrice || 0);
    const dep = parseFloat(o.deposit || 0);
    const ship = parseFloat(o.shipping || 0);
    const net = total + ship - dep;

    container.innerHTML+=`
    <div class="order-card ${isGrouped ? 'grouped' : ''}">
      <div class="card-header">
        <span class="order-id">#${orderId}</span>
        <span class="badge">${o.status || 'Pending'}</span>
      </div>
      
      <div class="field"><label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label><span>${o.customerName || "â€”"}</span></div>
      <div class="field"><label>Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†:</label><span>${o.phone || "â€”"}</span></div>

      <div class="spec-row">
        <span class="badge">Ø§Ù„ÙƒÙ…ÙŠØ©: ${qty}</span>
        <span class="badge">Ø§Ù„ÙˆØ²Ù†: ${weight} Ø¬Ù…</span>
        <span class="badge">Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯: ${dims}</span>
      </div>

      <div class="field">
        <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (EGP):</label>
        <input type="number" id="egp-${cleanOrderId}" value="${total}" oninput="recalc('${cleanOrderId}', ${ship})">
      </div>

      <div class="field">
        <label>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†:</label>
        <input type="number" id="deposit-${cleanOrderId}" style="color:red" value="${dep}" oninput="recalc('${cleanOrderId}', ${ship})">
      </div>

      <div class="net-box">
        <span class="net-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­ØµÙŠÙ„Ù‡ (Ø§Ù„ØµØ§ÙÙŠ)</span>
        <span class="net-value" id="net-${cleanOrderId}">${net.toLocaleString()} Ø¬.Ù…</span>
      </div>

      <div class="field">
        <label>Ø§Ù„ØªÙƒÙ„ÙØ© (USD):</label>
        <input type="number" id="usd-${cleanOrderId}" value="${parseFloat(o.usd||0).toFixed(2)}">
      </div>

      <div class="field">
        <label>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©:</label>
        <select id="status-${cleanOrderId}">
          <option ${o.status==="Pending Review"?"selected":""}>Pending Review</option>
          <option ${o.status==="Confirmed Via Try"?"selected":""}>Confirmed Via Try</option>
          <option ${o.status==="Processing"?"selected":""}>Processing</option>
          <option ${o.status==="Placed"?"selected":""}>Placed</option>
          <option ${o.status==="Shipped To You"?"selected":""}>Shipped To You</option>
          <option ${o.status==="Delivered"?"selected":""}>Delivered</option>
          <option ${o.status==="Canceled"?"selected":""}>Canceled</option>
        </select>
      </div>

      <div class="actions">
        <a href="${o.link || '#'}" target="_blank" class="link-btn">ğŸ”— Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ØªØ¬</a>
        <button class="btn-update" onclick="updateOrder('${cleanOrderId}')">âœ” Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
      </div>
    </div>
    `;
  });
}

function recalc(id, ship) {
    const egp = parseFloat(document.getElementById('egp-'+id).value) || 0;
    const dep = parseFloat(document.getElementById('deposit-'+id).value) || 0;
    document.getElementById('net-'+id).innerText = (egp + ship - dep).toLocaleString() + " Ø¬.Ù…";
}

function applyFilters(){
  const search=document.getElementById("searchInput").value.toLowerCase();
  const from=document.getElementById("dateFrom").value;
  const to=document.getElementById("dateTo").value;
  const status=document.getElementById("searchStatus").value;

  let filtered=ordersData.filter(o=>{
    const d=o.date?new Date(o.date).toISOString().split('T')[0]:"";
    const dateMatch=(!from||d>=from)&&(!to||d<=to);
    const statusMatch=!status||o.status===status;
    const searchMatch=(o.customerName||"").toLowerCase().includes(search)||
                      (o.phone||"").toString().includes(search)||
                      (o.order||"").toString().includes(search);
    return dateMatch&&statusMatch&&searchMatch;
  });

  if(isGrouped){
    const groups={};
    filtered.forEach(o=>{
      const key=o.phone||"Unknown";
      if(!groups[key]){
        groups[key]={...o, order:o.order, quantity:o.quantity||1, weight:o.weight||0, finalPrice:parseFloat(o.finalPrice||0), deposit:parseFloat(o.deposit||0), shipping:parseFloat(o.shipping||0), usd:parseFloat(o.usd||0)};
      }else{
        groups[key].quantity+=parseInt(o.quantity||1);
        groups[key].weight+=parseFloat(o.weight||0);
        groups[key].finalPrice+=parseFloat(o.finalPrice||0);
        groups[key].deposit+=parseFloat(o.deposit||0);
        groups[key].shipping+=parseFloat(o.shipping||0);
        groups[key].usd+=parseFloat(o.usd||0);
        groups[key].order+=" + "+o.order;
      }
    });
    filtered=Object.values(groups);
  }
  renderCards(filtered.reverse());
}

function toggleGrouping(){ isGrouped=!isGrouped; applyFilters(); }

function updateOrder(orderId){
  const newEGP=document.getElementById("egp-"+orderId).value;
  const newDeposit=document.getElementById("deposit-"+orderId).value;
  const newUSD=document.getElementById("usd-"+orderId).value;
  const newStatus=document.getElementById("status-"+orderId).value;

  fetch(scriptURL,{
    method:"POST",
    mode:"no-cors",
    body:JSON.stringify({
      action:"updateStatus",
      order:orderId,
      finalPrice:newEGP,
      deposit:newDeposit,
      usd:newUSD,
      status:newStatus
    })
  }).then(()=>{
    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨ #"+orderId);
    loadData();
  });
}

function logout(){
  localStorage.removeItem("auth");
  localStorage.removeItem("loginTime");
  location.reload();
}

loadData();
</script>

</body>
</html>
