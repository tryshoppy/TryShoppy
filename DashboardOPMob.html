<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRY SHOPPY - Mobile Fixed Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0d6efd; --bg: #f4f7fe; --white: #ffffff;
            --text: #1e293b; --border: #cbd5e1; --success: #22c55e;
        }

        body { font-family: 'Cairo', sans-serif; background-color: var(--bg); margin: 0; padding: 10px; color: var(--text); line-height: 1.5; }
        .container { max-width: 100%; margin: 0 auto; } 
        header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid var(--primary); padding-bottom: 8px; }
        
        .stats-grid { display: flex; justify-content: center; margin-bottom: 15px; }
        .stat-card { background: var(--white); padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-right: 5px solid #f59e0b; width: 100%; max-width: 320px; text-align: center; }
        .stat-card .value { font-size: 1.6rem; font-weight: 800; color: #f59e0b; }

        .filters { background: var(--white); padding: 15px; border-radius: 12px; display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filters input, .filters select { padding: 12px; border: 1px solid var(--border); border-radius: 10px; width: 100%; font-size: 14px; font-family: 'Cairo'; }
        
        .btn-search { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-group-action { background: #1a1a1a; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        @media screen and (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { background: var(--white); margin-bottom: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); padding: 10px; border: 1px solid var(--border); }
            
            /* Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ø®Ø·ÙˆØ· */
            td { 
                border: none; 
                padding: 12px 0; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø±Ø£Ø³ÙŠØ© */
                position: relative; 
                padding-right: 42%; 
                text-align: right; 
                border-bottom: 1px solid #f1f5f9; 
                min-height: 50px; /* Ø¶Ù…Ø§Ù† Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© Ù„ÙƒÙ„ Ø³Ø·Ø± */
                word-wrap: break-word; /* Ù…Ù†Ø¹ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù†Øµ Ø§Ù„Ø·ÙˆÙŠÙ„ */
            }
            td:last-child { border-bottom: none; }
            td::before { 
                content: attr(data-label); 
                position: absolute; 
                right: 0; 
                width: 38%; 
                font-weight: 700; 
                color: var(--primary); 
                font-size: 12px; 
                line-height: 1.2;
            }
            
            .price-input { width: 100% !important; margin: 4px 0; height: 40px; }
            select { width: 100% !important; margin: 4px 0; height: 40px; }
            .btn-update { width: 100%; margin-top: 10px; padding: 14px; font-size: 1rem; }
            .link-btn { display: block; width: 100%; text-align: center; margin-top: 5px; }
        }

        th { background: #f1f5f9; padding: 15px; font-size: 0.85rem; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; }
        .price-input { width: 85px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: center; font-weight: bold; }
        .spec-badge { background: #eff6ff; color: #1e40af; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; display: block; margin-top: 5px; line-height: 1.4; }
        .btn-update { background: var(--success); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .link-btn { color: var(--primary); text-decoration: none; font-weight: bold; font-size: 0.8rem; border: 1px solid var(--primary); padding: 6px 12px; border-radius: 6px; display: inline-block; }
    </style>
</head>
<body style="display:none;">

<script>
  const password = prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:");
  if (password === "12345678") { document.body.style.display = "block"; } 
  else { document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;'>Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ</h2>"; }
</script>

<div class="container">
    <header><h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… TRY SHOPPY</h1></header>

    <div class="stats-grid">
        <div class="stat-card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†Ø§Øª</h3><div id="totalCount" class="value">0</div></div>
    </div>

    <div class="filters">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="date" id="dateFrom">
            <input type="date" id="dateTo">
        </div>
        <input id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„...">
        <select id="searchStatus">
            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="Pending Review">Pending Review</option>
            <option value="Shipped To You">Shipped To You</option>
            <option value="Delivered">Delivered</option>
        </select>
        <button class="btn-search" onclick="applyFilters()">Ø¨Ø­Ø« ÙˆØªØ­Ø¯ÙŠØ«</button>
        <button id="groupBtn" class="btn-group-action" onclick="toggleGrouping()">ğŸ”„ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª</th><th>EGP</th><th>USD</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbyzDnWhqG4elYJcIsgPPUlVJoA4VjG2aysQoFs0n00kOUaxwkt1GCPBkAGW19_GOwox-A/exec";
let ordersData = [];
let isGrouped = false;

async function loadData() {
    try {
        const res = await fetch(scriptURL);
        ordersData = await res.json();
        applyFilters(); 
    } catch(e) { console.error(e); }
}

function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    data.forEach(o => {
        const cur = o.status || "Pending Review";
        const printOrder = o.order ? o.order.toString().split(' + ')[0] : 'N/A';
        const qtyDisplay = isGrouped ? o.totalQty : (o.quantity || 1);
        const weightValue = parseFloat(o.totalWeight || o.weight || 0).toFixed(2);
        const dimensionsValue = isGrouped ? "Ù…ØªØ¹Ø¯Ø¯Ø©" : (o.dimensions || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯");

        tbody.innerHTML += `<tr>
            <td data-label="Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"><b>${o.order}</b></td>
            <td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„"><b>${o.customerName}</b><br><small>${o.phone}</small></td>
            <td data-label="Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª">
                <span class="spec-badge">Ø§Ù„ÙƒÙ…ÙŠØ©: ${qtyDisplay}</span>
                <span class="spec-badge">Ø§Ù„ÙˆØ²Ù†: ${weightValue} ÙƒØ¬Ù…</span>
                <span class="spec-badge">Ø§Ù„ÙˆØµÙ: ${dimensionsValue}</span>
            </td>
            <td data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (EGP)"><input type="number" id="egp-${printOrder}" class="price-input" value="${o.finalPrice}"></td>
            <td data-label="Ø§Ù„ØªÙƒÙ„ÙØ© (USD)"><input type="number" id="usd-${printOrder}" class="price-input" value="${parseFloat(o.usd || 0).toFixed(2)}"></td>
            <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
                <select id="status-${printOrder}">
                    <option value="Pending Review" ${cur==='Pending Review'?'selected':''}>Pending Review</option>
                    <option value="Shipped To You" ${cur==='Shipped To You'?'selected':''}>Shipped To You</option>
                    <option value="Delivered" ${cur==='Delivered'?'selected':''}>Delivered</option>
                </select>
            </td>
            <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡"><button class="btn-update" onclick="updateOrder('${printOrder}')">ØªØ¹Ø¯ÙŠÙ„ âœ”</button></td>
            <td data-label="Ø§Ù„Ù…Ù†ØªØ¬">${o.link ? `<a href="${o.link}" target="_blank" class="link-btn">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</a>` : '-'}</td>
        </tr>`;
    });
}

// Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© applyFilters, toggleGrouping, updateOrder ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ
function applyFilters() {
    const from = document.getElementById("dateFrom").value;
    const to = document.getElementById("dateTo").value;
    const search = document.getElementById("searchInput").value.toLowerCase();
    const status = document.getElementById("searchStatus").value;
    let filtered = ordersData.filter(o => {
        const d = o.date ? new Date(o.date).toISOString().split('T')[0] : "";
        const dateMatch = (!from || d >= from) && (!to || d <= to);
        const searchMatch = (o.customerName||"").toLowerCase().includes(search) || (o.phone||"").toString().includes(search);
        const statusMatch = !status || o.status === status;
        return dateMatch && searchMatch && statusMatch;
    });
    document.getElementById("totalCount").innerText = filtered.length;
    if (isGrouped) {
        const groups = {};
        filtered.forEach(o => {
            const key = o.phone ? o.phone.toString().replace(/\s/g, '') : 'Unknown';
            if (!groups[key]) {
                groups[key] = { ...o, order: [o.order], count: 1, totalQty: parseInt(o.quantity || 1), totalWeight: parseFloat(o.weight || 0), finalPrice: parseFloat(o.finalPrice || 0), usd: parseFloat(o.usd || 0) };
            } else {
                groups[key].order.push(o.order);
                groups[key].totalQty += parseInt(o.quantity || 1);
                groups[key].totalWeight += parseFloat(o.weight || 0);
                groups[key].finalPrice += parseFloat(o.finalPrice || 0);
                groups[key].usd += parseFloat(o.usd || 0);
            }
        });
        filtered = Object.values(groups).map(g => ({ ...g, order: g.order.join(' + ') }));
    }
    renderTable(filtered);
}

function toggleGrouping() {
    isGrouped = !isGrouped;
    const btn = document.getElementById("groupBtn");
    btn.innerText = isGrouped ? "ğŸš« ÙÙƒ Ø§Ù„ØªØ¬Ù…ÙŠØ¹" : "ğŸ”„ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª";
    btn.classList.toggle("active");
    applyFilters(); 
}

async function updateOrder(orderId) {
    const newStatus = document.getElementById(`status-${orderId}`).value;
    const newEGP = document.getElementById(`egp-${orderId}`).value;
    const newUSD = document.getElementById(`usd-${orderId}`).value;
    try {
        await fetch(scriptURL, {
            method: "POST", mode: "no-cors",
            body: JSON.stringify({ action: "updateStatus", order: orderId, status: newStatus, finalPrice: newEGP, usd: newUSD })
        });
        alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"); loadData();
    } catch(err) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«"); }
}

loadData();
</script>
</body>
</html>