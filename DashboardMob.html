<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRY SHOPPY - Mobile Friendly Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0d6efd; --bg: #f4f7fe; --white: #ffffff;
            --text: #1e293b; --border: #cbd5e1; --success: #22c55e;
        }

        body { font-family: 'Cairo', sans-serif; background-color: var(--bg); margin: 0; padding: 10px; color: var(--text); }
        .container { max-width: 100%; margin: 0 auto; } 
        header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid var(--primary); padding-bottom: 5px; }
        
        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - Ø´Ø¨ÙƒØ© Ù…Ø±Ù†Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .stat-card { background: var(--white); padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-right: 4px solid var(--primary); text-align: center; }
        .stat-card h3 { margin: 0; font-size: 0.75rem; color: #64748b; }
        .stat-card .value { font-size: 1rem; font-weight: 800; color: var(--primary); }

        /* Ø§Ù„ÙÙ„Ø§ØªØ± - Ø¹Ù…ÙˆØ¯ÙŠØ© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        .filters { background: var(--white); padding: 15px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filters input, .filters select { padding: 12px; border: 1px solid var(--border); border-radius: 10px; width: 100%; font-size: 14px; }
        .btn-search { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; }
        
        .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-group-action { background: #1a1a1a; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-group-action.active { background: #dc2626; }
        .btn-print-all { background: #5b21b6; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ - ÙŠØªØ­ÙˆÙ„ Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        .table-wrapper { background: var(--white); border-radius: 12px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        
        @media screen and (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { background: var(--white); margin-bottom: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); padding: 15px; border: 1px solid var(--border); }
            td { border: none; padding: 10px 0; position: relative; padding-right: 45%; text-align: right; border-bottom: 1px solid #f1f5f9; }
            td:last-child { border-bottom: none; }
            td::before { content: attr(data-label); position: absolute; right: 0; width: 40%; font-weight: bold; color: var(--primary); font-size: 13px; text-align: right; }
            
            .price-input { width: 100% !important; margin: 5px 0; }
            select { width: 100% !important; margin: 5px 0; }
            .btn-update, .btn-print { width: 100%; margin-top: 5px; padding: 12px; }
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        th { background: #f1f5f9; padding: 15px; color: #475569; font-size: 0.85rem; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; }
        .price-input { width: 90px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: center; font-weight: bold; }
        .spec-badge { background: #eff6ff; color: #1e40af; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; display: block; margin-top: 3px; }
        .btn-print { background: #000; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-update { background: var(--success); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body style="display:none;">

<script>
  const password = prompt("Enter Password:");
  if (password === "945992") { document.body.style.display = "block"; } 
  else { document.body.innerHTML = "<h2 style='text-align:center;'>Access Denied âŒ</h2>"; }
</script>

<div class="container">
    <header><h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… TRY SHOPPY</h1></header>

    <div class="stats-grid">
        <div class="stat-card"><h3>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (EGP)</h3><div id="totalEGP" class="value">0</div></div>
        <div class="stat-card"><h3>Ø§Ù„ØªÙƒÙ„ÙØ© (USD)</h3><div id="totalUSD" class="value">0</div></div>
        <div class="stat-card"><h3>Ø§Ù„Ø´Ø­Ù†Ø§Øª</h3><div id="totalCount" class="value">0</div></div>
    </div>

    <div class="filters">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="date" id="dateFrom"> <input type="date" id="dateTo">
        </div>
        <input id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ØŒ Ø£Ùˆ Ø§Ù„Ø·Ù„Ø¨...">
        <select id="searchStatus">
            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="Pending Review">Pending Review</option>
            <option value="Shipped To You">Shipped To You</option>
            <option value="Delivered">Delivered</option>
        </select>
        <button class="btn-search" onclick="applyFilters()">Ø¨Ø­Ø« ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <div class="action-btns">
            <button id="groupBtn" class="btn-group-action" onclick="toggleGrouping()">ğŸ”„ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
            <button class="btn-print-all" onclick="printAllDisplayed()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</button>
        </div>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª</th><th>EGP</th><th>USD</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ØªØ­Ø¯ÙŠØ«</th><th>Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbyzDnWhqG4elYJcIsgPPUlVJoA4VjG2aysQoFs0n00kOUaxwkt1GCPBkAGW19_GOwox-A/exec";
let ordersData = [];
let currentFilteredData = [];
let isGrouped = false;

async function loadData() {
    try {
        const res = await fetch(scriptURL);
        ordersData = await res.json();
        applyFilters(); 
    } catch(e) { console.error(e); }
}

function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    data.forEach(o => {
        const cur = o.status || "Pending Review";
        const printOrder = o.order ? o.order.toString().split(' + ')[0] : 'N/A';
        const printPhone = o.phone ? o.phone.toString().replace(/\s/g, '') : '';
        const dimensionsValue = isGrouped ? "Ù…ØªØ¹Ø¯Ø¯Ø©" : (o.dimensions || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯");

        tbody.innerHTML += `<tr>
            <td data-label="Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"><b>${o.order}</b></td>
            <td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„"><b>${o.customerName}</b><br><small>${o.phone}</small></td>
            <td data-label="Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª">
                <span class="spec-badge">Ø§Ù„ÙƒÙ…ÙŠØ©: ${isGrouped ? o.totalQty : (o.quantity || 1)}</span>
                <span class="spec-badge">Ø§Ù„ÙˆØ²Ù†: ${parseFloat(o.totalWeight || o.weight || 0).toFixed(2)} Ø¬Ù…</span>
                <span class="spec-badge">Ø§Ù„ÙˆØµÙ: ${dimensionsValue}</span>
            </td>
            <td data-label="Ø§Ù„Ù…ØµØ±ÙŠ (EGP)"><input type="number" id="egp-${printOrder}" class="price-input" value="${o.finalPrice || 0}"></td>
            <td data-label="Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (USD)"><input type="number" id="usd-${printOrder}" class="price-input" value="${parseFloat(o.usd || 0).toFixed(2)}"></td>
            <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
                <select id="status-${printOrder}">
                    <option value="Pending Review" ${cur==='Pending Review'?'selected':''}>Pending Review</option>
                    <option value="Shipped To You" ${cur==='Shipped To You'?'selected':''}>Shipped To You</option>
                    <option value="Delivered" ${cur==='Delivered'?'selected':''}>Delivered</option>
                </select>
            </td>
            <td data-label="Ø¥Ø¬Ø±Ø§Ø¡"><button class="btn-update" onclick="updateOrder('${printOrder}')">âœ”</button></td>
            <td data-label="Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©"><button class="btn-print" onclick="printLabel('${printPhone}', '${printOrder}')">ğŸ“„ Ø¨ÙˆÙ„ÙŠØµØ©</button></td>
        </tr>`;
    });
}

function applyFilters() {
    const from = document.getElementById("dateFrom").value;
    const to = document.getElementById("dateTo").value;
    const search = document.getElementById("searchInput").value.toLowerCase();
    const status = document.getElementById("searchStatus").value;

    let filtered = ordersData.filter(o => {
        const d = o.date ? new Date(o.date).toISOString().split('T')[0] : "";
        const dateMatch = (!from || d >= from) && (!to || d <= to);
        const searchMatch = (o.customerName||"").toLowerCase().includes(search) || 
                            (o.phone||"").toString().includes(search) || 
                            (o.order||"").toString().toLowerCase().includes(search);
        const statusMatch = !status || o.status === status;
        return dateMatch && searchMatch && statusMatch;
    });

    document.getElementById("totalEGP").innerText = filtered.reduce((a,b) => a + parseFloat(b.finalPrice || 0), 0).toLocaleString();
    document.getElementById("totalUSD").innerText = filtered.reduce((a,b) => a + parseFloat(b.usd || 0), 0).toLocaleString();
    document.getElementById("totalCount").innerText = filtered.length;

    if (isGrouped) {
        const groups = {};
        filtered.forEach(o => {
            const key = o.phone ? o.phone.toString().replace(/\s/g, '') : 'Unknown';
            if (!groups[key]) {
                groups[key] = { ...o, order: [o.order], count: 1, totalQty: parseInt(o.quantity || 1), totalWeight: parseFloat(o.weight || 0), finalPrice: parseFloat(o.finalPrice || 0), usd: parseFloat(o.usd || 0) };
            } else {
                groups[key].order.push(o.order);
                groups[key].count += 1;
                groups[key].totalQty += parseInt(o.quantity || 1);
                groups[key].totalWeight += parseFloat(o.weight || 0);
                groups[key].finalPrice += parseFloat(o.finalPrice || 0);
                groups[key].usd += parseFloat(o.usd || 0);
            }
        });
        filtered = Object.values(groups).map(g => ({ ...g, order: g.order.join(' + ') }));
    }
    currentFilteredData = filtered; 
    renderTable(filtered);
}

function toggleGrouping() {
    isGrouped = !isGrouped;
    const btn = document.getElementById("groupBtn");
    btn.innerText = isGrouped ? "ğŸš« ÙÙƒ Ø§Ù„ØªØ¬Ù…ÙŠØ¹" : "ğŸ”„ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª";
    btn.classList.toggle("active");
    applyFilters(); 
}

function updateOrder(orderId) {
    const newStatus = document.getElementById(`status-${orderId}`).value;
    const newEGP = document.getElementById(`egp-${orderId}`).value;
    const newUSD = document.getElementById(`usd-${orderId}`).value;
    fetch(scriptURL, {
        method: "POST", mode: "no-cors",
        body: JSON.stringify({ action: "updateStatus", order: orderId, status: newStatus, finalPrice: newEGP, usd: newUSD })
    }).then(() => { alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); loadData(); });
}

// Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´ÙƒÙ„ (ØªÙ…Øª Ø¥Ø¹Ø§Ø¯ØªÙ‡Ø§ Ù„Ø£ØµÙ„Ù‡Ø§ 100% ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª)
function generateLabelHTML(data, isBulk = false) {
    const totalP = data.finalPrice || 0;
    const totalW = parseFloat(data.totalWeight || data.weight || 0).toFixed(2);
    const totalQ = data.totalQty || data.quantity || 1;
    const ids = data.order;
    return `
        <div class="card" style="${isBulk ? 'page-break-after: always;' : ''} border: 4px solid #000; height: 185mm; position: relative; padding: 15px; box-sizing: border-box; background: #fff; direction: rtl;">
            <div style="border-bottom: 4px solid #000; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 30pt; font-weight: 900;">TRY SHOPPY</div>
                <div style="font-size: 10pt; text-align: center; border: 1px solid #000; padding: 5px;">AIRWAY BILL<br>OFFICIAL</div>
            </div>
            <div style="margin-top: 20px; font-size: 15pt; line-height: 1.6;">
                <span>Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ¯/Ø©:</span> <b>${data.customerName}</b><br>
                ğŸ“ ${data.governorate} - ${data.address}<br>
                ğŸ“ ${data.phone}
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 20px; border-top: 1px solid #000; padding-top: 15px; font-size: 14pt;">
                <div>Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b>${totalW} Ø¬Ø±Ø§Ù…</b></div>
                <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·Ø¹: <b>${totalQ}</b></div>
            </div>
            <div style="background: #000; color: #fff; padding: 10px; margin-top: 20px; text-align: center; font-size: 9pt; word-break: break-all;">Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${ids}</div>
            <div style="border: 5px solid #000; margin-top: 20px; padding: 20px; text-align: center;">
                <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­ØµÙŠÙ„Ø© -Ø´Ø§Ù…Ù„ Ø§Ù„Ø´Ø­Ù† (C.O.D)</span>
                <div style="font-size: 40pt; font-weight: 700;">${totalP} EGP</div>
            </div>
            <div style="position: absolute; bottom: 15px; width: 92%; text-align: center; font-size: 10pt; font-weight: bold;">Ù…Ø³Ù…ÙˆØ­ ÙØªØ­ Ø§Ù„Ø´Ø­Ù†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… | ØªØ±Ø§ÙŠ Ø´ÙˆØ¨ÙŠ ØªØªÙ…Ù†ÙŠ Ù„ÙƒÙ… ØªØ¬Ø±Ø¨Ø© Ø³Ø¹ÙŠØ¯Ù‡</div>
        </div>
    `;
}

function printLabel(phone, orderId) {
    const subset = ordersData.filter(x => x.phone && x.phone.toString().replace(/\s/g, '') === phone);
    let toPrint = isGrouped ? currentFilteredData.find(x => x.phone.toString().replace(/\s/g, '') === phone) : subset.find(x => x.order.toString() === orderId.toString());
    const win = window.open('', '_blank');
    win.document.write(`<html><head><link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet"><style>@page{size: A5; margin: 0;} body{font-family:'Cairo';margin:0;padding:10mm;}</style></head><body>${generateLabelHTML(toPrint)}<script>window.onload=function(){window.print();window.close();};<\/script></body></html>`);
    win.document.close();
}

function printAllDisplayed() {
    const win = window.open('', '_blank');
    let allLabelsHTML = "";
    currentFilteredData.forEach(item => { allLabelsHTML += generateLabelHTML(item, true); });
    win.document.write(`<html><head><link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet"><style>@page{size: A5; margin: 0;} body{font-family:'Cairo';margin:0;padding:10mm;} @media print{.no-print{display:none;}}</style></head><body>${allLabelsHTML}<script>window.onload=function(){window.print();window.close();};<\/script></body></html>`);
    win.document.close();
}

loadData();
</script>
</body>
</html>